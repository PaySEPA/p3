<div ng-controller="ExternalAccountsController as model">
  <div class="section section-credit-cards">
    <headline-menu headline="Credit Cards" loading="model.state.loading">
      <ul class="stackable-menu dropdown-menu">
        <li>
          <a class="stackable-cancel" ng-click="model.modals.showAddCreditCard=true"><i class="icon-plus"></i> Add Credit Card</a>
        </li>
      </ul>
    </headline-menu>
    <table class="table table-condensed" data-ng-show="(model.state.loading && model.creditCards.length > 0) || model.creditCards.length > 0">
      <thead>
        <tr>
          <th class="name">Name</th>
          <th class="name">Brand</th>
          <th class="name">Number</th>
          <th>Expiration</th>
          <th class="compact">
            <span
              data-tooltip-title="Links from accounts to this payment method. A payment method cannot be deleted while linked."
              data-placement="bottom" data-trigger="hover"><i class="icon icon-link"></i></span>
          </th>
          <th class="action">Action</th>
        </tr>
      </thead>
      <tbody>
      <tr ng-repeat="card in model.creditCards | orderBy:'label'"
        data-fadeout="card.deleted"
        data-fadeout-callback="model.deletePaymentToken(card)"
        data-fadein="card.showDeletedError"
        data-fadein-callback="card.animateDeletedError=true"
        data-animate="card.animateDeletedError"
        data-animate-options="[{properties: {opacity: 0}, duration: 500},{properties: {opacity: 1}, duration: 500}]"
        data-animate-callback="card.animateDeletedError=false;card.showDeletedError=false"
        data-ng-class="{warning: card.showExpirationWarning, error: card.showExpired}">
        <!-- Name -->
        <td>
          <span>{{card.label}}</span>
        </td>
        <!-- Brand -->
        <td>
          <span><i class="{{card.cardBrand|cardBrand:true}}"></i></span>
        </td>
        <!-- Number -->
        <td>
          <span>{{card.cardNumber}}</span>
        </td>
        <!-- Expiration -->
        <td>
          <!-- FIXME: add warning for near or already expired cards -->
          <span>{{card.cardExpMonth}} / {{card.cardExpYear}}</span>
          <span data-ng-show="card.showExpirationWarning"
            data-tooltip-title="This payment method will expire in less than a month. Please update or replace the credit card information."
            data-placement="bottom" data-trigger="hover"><i class="icon icon-warning-sign"></i></span>
          <span data-ng-show="card.showExpired"
            data-tooltip-title="This payment method has expired. Please update or replace the credit card information."
            data-placement="bottom" data-trigger="hover"><i class="icon icon-warning-sign"></i></span>
        </td>
        <!-- Links -->
        <td class="compact">
          <span class="badge">{{card.backupSourceFor.length || ''}}</span>
        </td>
        <!-- Action -->
        <td class="action">
          <action-menu>
            <ul class="dropdown-menu stackable-menu">
              <li>
                <a class="stackable-cancel"
                  ng-click="model.modals.paymentToken=card; model.modals.showEditPaymentToken=true">
                  <i class="icon-pencil"></i> Edit
                </a>
              </li>
              <li class="divider"></li>
              <li data-ng-class="{disabled: card.backupSourceFor.length, 'btn-danger': !card.backupSourceFor.length}">
                <a class="stackable-cancel" data-ng-show="card.backupSourceFor.length" href="#">
                  <i class="icon-remove"></i> Delete
                </a>
                <a class="stackable-cancel" data-ng-hide="card.backupSourceFor.length" data-ng-click="card.deleted=true">
                  <i class="icon-remove"></i> Delete
                </a>
              </li>
            </ul>
          </action-menu>
        </td>
      </tr>
      </tbody>
    </table>
    <div ng-show="!model.state.loading && model.creditCards.length == 0">
      <p class="center">You have no credit cards associated with this identity.</p>
    </div>
    <stackable-modal stackable="model.modals.showAddCreditCard">
      <div data-add-payment-token-modal data-payment-methods="model.creditCardMethods"></div>
    </stackable-modal>
    <stackable-modal stackable="model.modals.showEditPaymentToken">
      <div data-edit-payment-token-modal data-payment-token="model.modals.paymentToken"></div>
    </stackable-modal>
  </div>

  <div class="section section-bank-accounts">
    <headline-menu headline="Bank Accounts" loading="model.state.loading">
      <ul class="stackable-menu dropdown-menu">
        <li>
          <a class="stackable-cancel" ng-click="model.modals.showAddBankAccount=true"><i class="icon-plus"></i> Add Bank Account</a>
        </li>
      </ul>
    </headline-menu>
    <table class="table table-condensed" ng-show="(model.state.loading && model.bankAccounts.length > 0) || model.bankAccounts.length > 0">
      <thead>
        <tr>
          <th>Name</th>
          <th>Number</th>
          <th>Routing</th>
          <th>Status</th>
          <th class="action">Action</th>
        </tr>
      </thead>
      <tbody>
      <tr ng-repeat="bankAccount in model.bankAccounts | orderBy:'label'"
        ng-class="{info: bankAccount.sysStatus == 'active' && !bankAccount.sysVerified && bankAccount.sysVerifyReady}">
        <!-- Name -->
        <td>
          <span>{{bankAccount.label}}</span>
        </td>
        <!-- Number -->
        <td>
          <span>{{bankAccount.bankAccount}}</span>
        </td>
        <!-- Routing -->
        <td>
          <span>{{bankAccount.bankRoutingNumber}}</span>
        </td>
        <!-- Status -->
        <td data-ng-show="bankAccount.sysStatus == 'active' || bankAccount.sysStatus == 'disabled'">
          <button data-ng-show="bankAccount.sysStatus == 'active' && !bankAccount.sysVerified && bankAccount.sysVerifyReady"
            data-ng-click="model.modals.paymentToken=bankAccount; model.modals.showVerifyBankAccountModal=true"
            class="btn btn-primary" title="Verify">Verify</button>
          <span data-ng-show="bankAccount.sysStatus == 'disabled'"
            data-tooltip-title="This payment method was likely disabled because your bank account information could not be verified. Please delete this payment method and try to add it again with corrected information."
            data-placement="bottom" data-trigger="hover" class="label label-important">Disabled</span>
          <span data-ng-show="bankAccount.sysStatus != 'active' && bankAccount.sysStatus != 'disabled' && bankAccount.sysStatus != 'deleted' && !bankAccount.sysVerified" class="label label-warning">Unverified</span>
          <span data-ng-show="bankAccount.sysStatus == 'active' && !bankAccount.sysVerified && !bankAccount.sysVerifyReady" class="label label-info">Pending</span>
          <span data-ng-show="bankAccount.sysVerified" class="label label-success">Verified</span>
        </td>
        <td data-ng-show="bankAccount.sysStatus == 'deleted'">
          <span
            data-tooltip-title="Because verifying a bank account is a costly process, we do not delete bank accounts immediately. You may restore the bank account before the expiration date passes if you wish."
            data-placement="bottom" data-trigger="hover" class="label label-warning">Expires {{bankAccount.sysExpires | date:'MMM d'}}</span>
        </td>
        <!-- Action -->
        <td class="action">
          <action-menu>
            <ul class="dropdown-menu stackable-menu">
              <li>
                <a class="stackable-cancel"
                  data-ng-click="model.modals.paymentToken=bankAccount; model.modals.showEditPaymentToken=true">
                  <i class="icon-pencil"></i> Edit
                </a>
              </li>
              <li class="divider"></li>
              <li class="btn-danger"
                data-ng-show="bankAccount.sysStatus == 'active' || bankAccount.sysStatus == 'disabled'"
                data-ng-disabled="!bankAccount.sysVerified && bankAccount.sysStatus != 'disabled'">
                <a class="stackable-cancel" data-ng-click="model.deletePaymentToken(bankAccount)">
                  <i class="icon-trash"></i> Delete
                </a>
              </li>
              <li class="btn-success"
                data-ng-show="!bankAccount.sysStatus || bankAccount.sysStatus == 'deleted'">
                <a class="stackable-cancel" data-ng-click="model.restorePaymentToken(bankAccount)">
                  <i class="icon-undo"></i> Restore
                </a>
              </li>
            </ul>
          </action-menu>
        </td>
      </tr>
      </tbody>
    </table>
    <div data-ng-show="!model.state.loading && model.bankAccounts.length == 0">
      <p class="center">You have no bank accounts associated with this identity.</p>
    </div>
    <stackable-modal stackable="model.modals.showAddBankAccount">
      <div data-add-payment-token-modal data-payment-methods="model.bankAccountMethods"></div>
    </stackable-modal>
    <stackable-modal stackable="model.modals.showVerifyBankAccountModal">
      <div data-verify-bank-account-modal data-payment-token="model.modals.paymentToken"></div>
    </stackable-modal>
  </div>
</div>
